{% extends 'base.html' %}
{% load static %}

{% block content %}
    <div class="content-wrapper">
        <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Hujjat Tafsilotlari</h4>
                        <div class="mb-3">
                            <a href="{% url 'main:document_list' %}" class="btn btn-outline-primary mb-2"><i class="fa fa-arrow-left"></i> Ro'yxatga qaytish</a>
                            <a href="{% url 'main:document_list' %}" class="btn btn-outline-warning mb-2"><i class="fa fa-edit"></i> Tahrirlash</a>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Fan:</strong> {{ document.subject.name }}</p>
                                <p><strong>Sana:</strong> {{ document.created_at|date:"d-M, Y" }} {{ document.created_at|time:"H:i" }}</p>
                                <p><strong>Holat:</strong>
                                    {% if document.overall == 'accepted' %}
                                        <span class="badge bg-success">Qabul qilindi</span>
                                    {% elif document.overall == 'cancelled' %}
                                        <span class="badge bg-danger">Rad etildi</span>
                                    {% elif document.overall == 'no process' %}
                                        <span class="badge bg-secondary">Jarayonda emas</span>
                                    {% else %}
                                        <span class="badge bg-warning text-dark">Jarayonda</span>
                                    {% endif %}
                                </p>
                                <p><strong>Status:</strong>
                                    {% if document.status == True %}
                                        <span class="badge bg-success">Faol</span>
                                    {% else %}
                                        <span class="badge bg-secondary text-dark">Faol emas</span>
                                    {% endif %}
                                </p>
                                <p><strong>Fayl:</strong>
                                    <span class="badge bg-primary">{{ document.file_name }}</span>
                                </p>
                                <p class="form-multiline"><strong>Izoh:</strong>
                                    {{ document.document_comment }}
                                </p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Kafedra:</strong>
                                    {% if document.department_head_sign == 'waiting' %}
                                        <span class="badge bg-warning text-dark">Kutilmoqda</span>
                                    {% elif document.department_head_sign == 'cancelled' %}
                                        <span class="badge bg-danger">Rad etildi</span>
                                    {% elif document.department_head_sign == 'accepted' %}
                                        <span class="badge bg-success">Qabul qilindi</span>
                                    {% elif document.department_head_sign == 'no process' %}
                                        <span class="badge bg-secondary">Jarayonda emas</span>
                                    {% endif %}
                                </p>
                                <p><strong>Dekan:</strong>
                                    {% if document.dean_sign == 'waiting' %}
                                        <span class="badge bg-warning text-dark">Kutilmoqda</span>
                                    {% elif document.dean_sign == 'cancelled' %}
                                        <span class="badge bg-danger">Rad etildi</span>
                                    {% elif document.dean_sign == 'accepted' %}
                                        <span class="badge bg-success">Qabul qilindi</span>
                                    {% elif document.dean_sign == 'no process' %}
                                        <span class="badge bg-secondary">Jarayonda emas</span>
                                    {% endif %}
                                </p>
                                <p><strong>O'quv bo'limi:</strong>
                                    {% if document.study_head_sign == 'waiting' %}
                                        <span class="badge bg-warning text-dark">Kutilmoqda</span>
                                    {% elif document.study_head_sign == 'cancelled' %}
                                        <span class="badge bg-danger">Rad etildi</span>
                                    {% elif document.study_head_sign == 'accepted' %}
                                        <span class="badge bg-success">Qabul qilindi</span>
                                    {% elif document.study_head_sign == 'no process' %}
                                        <span class="badge bg-secondary">Jarayonda emas</span>
                                    {% endif %}
                                </p>
                                <p><strong>Prorektor:</strong>
                                    {% if document.study_prorector_sign == 'waiting' %}
                                        <span class="badge bg-warning text-dark">Kutilmoqda</span>
                                    {% elif document.study_prorector_sign == 'cancelled' %}
                                        <span class="badge bg-danger">Rad etildi</span>
                                    {% elif document.study_prorector_sign == 'accepted' %}
                                        <span class="badge bg-success">Qabul qilindi</span>
                                    {% elif document.study_prorector_sign == 'no process' %}
                                        <span class="badge bg-secondary">Jarayonda emas</span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                    <div class="card-body">
                        <h4 class="card-title">Faylni ko'rish</h4>
                        <div class="mb-1">
                            <a href="{% url 'main:download_file' document.pk %}" class="btn btn-outline-primary mb-2"><i class="fa fa-arrow-down"></i>Yuklab olish</a>
                            <button onclick="openFullscreen()" class="btn btn-outline-primary mb-2"><i class="fa fa-expand"></i> To'liq ekran</button>
                        </div>
                        <div id="file-viewer">Fayl yuklanmoqda</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
    async function fetchFile(fileId) {
        try {
            const response = await fetch(`/document/${fileId}/view/`);
            if (!response.ok) {
                throw new Error('Faylni olishda xatolik yuz berdi');
            }
            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const fileViewer = document.getElementById('file-viewer');
            fileViewer.innerHTML = `
                <embed src="${url}" width="100%" height="700px" type="application/pdf" id="pdf-embed">
            `;
        } catch (error) {
            console.error('Xatolik:', error);
            document.getElementById('file-viewer').innerHTML = 'Faylni yuklashda xato yuz berdi.';
        }
    }

    function openFullscreen() {
        const embedElement = document.getElementById('pdf-embed');
        if (embedElement.requestFullscreen) {
            embedElement.requestFullscreen();
        } else if (embedElement.mozRequestFullScreen) { // Firefox
            embedElement.mozRequestFullScreen();
        } else if (embedElement.webkitRequestFullscreen) { // Chrome, Safari, and Opera
            embedElement.webkitRequestFullscreen();
        } else if (embedElement.msRequestFullscreen) { // IE/Edge
            embedElement.msRequestFullscreen();
        }
    }

    // Fayl ID sini berish
    fetchFile({{ document.pk }}); // Bu erda fayl ID sini kiriting
</script>
{% endblock %}
